name: Booktests

on:
  push:
    paths: ['demos/**/*.ipynb', '.github/workflows/booktests.yml']
  pull_request:
    paths: ['demos/**/*.ipynb', '.github/workflows/booktests.yml']

jobs:
  booktests:
    timeout-minutes: 120
    name: Notebook Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: qmcpy
          python-version: "3.11"
          auto-activate-base: false

      - name: Install LaTeX (Linux)
        if: runner.os == 'Linux'
        shell: bash -l {0}
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended

      - name: Install LaTeX (macOS)
        if: runner.os == 'macOS'
        shell: bash -l {0}
        run: |
          brew install basictex
          sudo tlmgr update --self
          sudo tlmgr install latexmk

      - name: Install project + test extras in Conda env
        shell: bash -l {0}
        run: python -m pip install -U pip wheel setuptools && python -m pip install -e ".[test]"

      - name: Sanity check Parsl in Conda env
        shell: bash -l {0}
        run: python - <<'PY'
import parsl, sys; print("parsl", parsl.__version__); print(sys.executable)
PY

      - name: Run notebook tests
        shell: bash -l {0}
        run: |
          export PARSL_WORKERS=$(python -c 'import os;print(os.cpu_count() or 2)')
          make booktests_parallel_no_docker TESTS="tb_dakota_genz"
