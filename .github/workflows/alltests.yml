name: All Tests
# on:
#   push:
#     branches:
#       - master 
on: [push]

jobs:
  tests:
    name: All Tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
        matrix:
            os: [ "windows-latest"]  # "macos-latest", "ubuntu-latest",
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          auto-activate-base: true
          conda-remove-defaults: true
      # -----------------------------------------------------------
      # Add 12GB swap (Linux only)
      # -----------------------------------------------------------
      - name: Add 12GB swap
        if: runner.os == 'Linux'
        run: |
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Add 12GB swap (macOS)
        if: runner.os == 'macOS'
        run: |
          # Create and mount a temporary swapfile
          sudo mkfile 12g /private/var/vm/tempswapfile
          sudo chmod 600 /private/var/vm/tempswapfile
          # Show memory stats
          vm_stat

      - name: Add swap space (Windows)
        if: runner.os == 'Windows'
        run: |
          # Check current pagefile settings
          Get-WmiObject Win32_PageFileUsage | Select-Object Name, AllocatedBaseSize
          # Display system memory info
          Get-ComputerInfo -Property CsTotalPhysicalMemory

      # -----------------------------------------------------------
      # Free disk + conda cache early
      # -----------------------------------------------------------
      - name: Free space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          conda clean --all --yes
          pip cache purge || true
          df -h

      - name: Free space (macOS)
        if: runner.os == 'macOS'
        run: |
          conda clean --all --yes
          pip cache purge || true
          df -h

      - name: Free space (Windows)
        if: runner.os == 'Windows'
        run: |
          conda clean --all --yes || true
          pip cache purge || true
          Get-Volume | Select-Object DriveLetter, Size, SizeRemaining | Format-Table

      - name: Show runner resources
        if: runner.os == 'Linux'
        run: |
          echo "CPUs: $(nproc || sysctl -n hw.ncpu)"
          free -h || vm_stat
          df -h

      - run: pip install -e .[test]

      # -----------------------------------------------------------
      # Install minimal LaTeX (OS-specific)
      # -----------------------------------------------------------
      - name: Install minimal LaTeX (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y texlive-latex-base texlive-latex-extra texlive-latex-recommended latexmk dvipng cm-super ghostscript

      - name: Install minimal LaTeX (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install --cask basictex
          eval "$(/usr/libexec/path_helper)"
          sudo tlmgr update --self
          sudo tlmgr install latexmk dvipng collection-fontsrecommended type1cm
          
      - name: Install MiKTeX + deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          choco install miktex -y
          choco install ghostscript -y
          choco install strawberryperl -y

      - name: Configure MiKTeX (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Try to find MiKTeX binaries robustly
          $miktexBin = "C:\Program Files\MiKTeX\miktex\bin\x64"
          if (-not (Test-Path $miktexBin)) {
            # fallback: search typical locations
            $miktexBin = (Get-ChildItem "C:\Program Files\MiKTeX" -Recurse -Directory -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -match "\\miktex\\bin\\x64$" } |
              Select-Object -First 1 -ExpandProperty FullName)
          }
          if (-not $miktexBin) { throw "Could not locate MiKTeX bin directory." }
          $env:PATH = "$miktexBin;$env:PATH"

          # Enable install-on-the-fly (shared/admin)
          initexmf --admin --set-config-value "[MPM]AutoInstall=1"
          initexmf --admin --set-config-value "[MPM]AutoAdmin=1"

          # Refresh FNDB + links (often needed after CI installs)
          initexmf --admin --update-fndb
          initexmf --admin --mklinks --force

          # Update package database + packages using the supported CLI
          miktex --admin packages update-package-database
          miktex --admin packages update

      - name: Verify LaTeX toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          latex --version
          pdflatex --version
          perl -v
          gswin64c -v
          latexmk -v
          dvipng --version
        

      - run: pip freeze
      - run: make doctests_minimal
      - run: pip install -e .[test_torch] 
      - run: make doctests_torch 
      - run: pip install -e .[test_gpytorch]
      - run: make doctests_gpytorch
      - run: pip install -e .[test_botorch]
      - run: make doctests_botorch
      - run: pip install -e .[test_umbridge]
      - name: run umbridge doctests on Linux only
        shell: bash -l {0}
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            make doctests_umbridge
          else
            echo "umbridge doctests only run on Linux"
          fi
      - run: make doctests_markdown
      - name: Run unittests (parallel)
        run: |
          python -m pytest -n auto -q
      - name: Check for missing booktest files
        run: make check_booktests

      - name: Generate missing booktest files
        run: make generate_booktests

      - name: Run booktests (parallel) on macOS/Ubuntu
        if: runner.os != 'Windows'
        shell: bash -l {0}
        run: |
          make booktests_parallel_no_docker

      - name: Run booktests (parallel) on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Execute notebook integration tests in parallel
          $env:MPLBACKEND = "Agg"
          #python -m pytest -n auto -q test/booktests
          #python -m pytest -q test/booktests --maxfail=1 -vv     # sequential