name: All Tests
# on:
#   push:
#     branches:
#       - master 
on: [push]

jobs:
  tests:
    name: All Tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
        matrix:
            os: ["macos-latest", "ubuntu-latest", "windows-latest"]
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          auto-activate-base: true
      # -----------------------------------------------------------
      # Add 12GB swap (Linux only)
      # -----------------------------------------------------------
      - name: Add 12GB swap
        if: runner.os == 'Linux'
        run: |
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # -----------------------------------------------------------
      # Free disk + conda cache early
      # -----------------------------------------------------------
      - name: Free space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          conda clean --all --yes
          pip cache purge || true
          df -h

      - name: Free space (macOS)
        if: runner.os == 'macOS'
        run: |
          conda clean --all --yes
          pip cache purge || true

      - name: Show runner resources
        if: runner.os == 'Linux'
        run: |
          echo "CPUs: $(nproc || sysctl -n hw.ncpu)"
          free -h || vm_stat
          df -h
      - run: pip install -e .[test]
      # -----------------------------------------------------------
      # Install minimal LaTeX (OS-specific)
      # -----------------------------------------------------------
      - name: Install minimal LaTeX (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y texlive-latex-base texlive-latex-extra texlive-latex-recommended latexmk dvipng cm-super ghostscript

      - name: Install minimal LaTeX (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install --cask basictex
          eval "$(/usr/libexec/path_helper)"
          sudo tlmgr update --self
          sudo tlmgr install latexmk dvipng collection-fontsrecommended type1cm
          
      - name: Install minimal LaTeX (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install miktex -y || true
          refreshenv || true
          # update file name database if available
          initexmf --update-fndb || true
          # try to update package database (may be available as mpm)
          mpm --admin --update-db || true
      - run: pip freeze
      - run: make doctests_minimal
      - run: pip install -e .[test_torch] 
      - run: make doctests_torch 
      - run: pip install -e .[test_gpytorch]
      - run: make doctests_gpytorch
      - run: pip install -e .[test_botorch]
      - run: make doctests_botorch
      - run: pip install -e .[test_umbridge]
      - name: run umbridge doctests on Linux only
        shell: bash -l {0}
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            make doctests_umbridge
          else
            echo "umbridge doctests only run on Linux"
          fi
      - run: make doctests_markdown
      - run: make unittests
      - name: Check for missing booktest files
        run: make check_booktests

      - name: Generate missing booktest files
        run: make generate_booktests

      - name: Run booktests (parallel) on macOS/Ubuntu
        if: runner.os != 'Windows'
        shell: bash -l {0}
        run: |
          make booktests_parallel_no_docker

      - name: Run booktests (sequential) on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd test/booktests && python -m unittest discover -p "tb_*.py" -v
      - run: make coverage

