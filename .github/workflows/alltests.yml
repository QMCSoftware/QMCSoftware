name: Run all tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
        exclude:
          # Exclude some combinations to reduce CI time
          - os: macos-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.9'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get pip cache dir
        id: pip-cache
        shell: bash
        run: |
          echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov coverage

      - name: Run unit tests
        shell: bash
        run: |
          echo "Running unit tests..."
          python -m pytest test/fasttests --cov=qmcpy --cov-report=xml --cov-report=term -v

      - name: Run integration tests
        shell: bash
        run: |
          echo "Running integration tests..."
          python -m pytest test/longtests --cov=qmcpy --cov-append --cov-report=xml --cov-report=term -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          env_vars: OS,PYTHON
          name: codecov-umbrella
          fail_ci_if_error: false

  test-notebooks:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install jupyter nbconvert nbformat pytest pytest-cov coverage

      - name: Test workouts
        run: |
          echo "Testing workout notebooks..."
          for notebook in workouts/wo*.ipynb; do
            echo "Testing $notebook"
            jupyter nbconvert --to notebook --execute --inplace "$notebook" || exit 1
          done

      - name: Test integration demos
        run: |
          echo "Testing integration demo notebooks..."
          for notebook in demos/integration_examples*.ipynb; do
            echo "Testing $notebook"
            jupyter nbconvert --to notebook --execute --inplace "$notebook" || exit 1
          done

  test-memory:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov memory_profiler

      - name: Run memory tests
        run: |
          echo "Running memory profiling tests..."
          python -m pytest test/memory_tests -v

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint

      - name: Run flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 qmcpy --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 qmcpy --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run pylint
        run: |
          pylint qmcpy --exit-zero

  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install sphinx sphinx_rtd_theme

      - name: Build documentation
        run: |
          cd sphinx
          make html

  test-booktests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        test-group: [
          'chapter1',
          'chapter2',
          'chapter3',
          'chapter4',
          'chapter5',
          'chapter6',
          'chapter7',
          'chapter8',
          'appendix'
        ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get pip cache dir
        id: pip-cache
        shell: bash
        run: |
          echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: ${{ runner.os }}-pip-booktests-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-booktests-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-booktests-

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install jupyter nbconvert nbformat pytest pytest-cov coverage ipykernel
          python -m ipykernel install --user --name python3

      - name: List notebooks for ${{ matrix.test-group }}
        shell: bash
        run: |
          case "${{ matrix.test-group }}" in
            chapter1)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter1*.ipynb" >> $GITHUB_ENV
              ;;
            chapter2)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter2*.ipynb" >> $GITHUB_ENV
              ;;
            chapter3)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter3*.ipynb" >> $GITHUB_ENV
              ;;
            chapter4)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter4*.ipynb" >> $GITHUB_ENV
              ;;
            chapter5)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter5*.ipynb" >> $GITHUB_ENV
              ;;
            chapter6)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter6*.ipynb" >> $GITHUB_ENV
              ;;
            chapter7)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter7*.ipynb" >> $GITHUB_ENV
              ;;
            chapter8)
              echo "NOTEBOOKS=demos/mcqmc2024/Chapter8*.ipynb" >> $GITHUB_ENV
              ;;
            appendix)
              echo "NOTEBOOKS=demos/mcqmc2024/Appendix*.ipynb" >> $GITHUB_ENV
              ;;
          esac

      - name: Test ${{ matrix.test-group }} notebooks
        shell: bash
        run: |
          echo "Testing notebooks matching pattern: $NOTEBOOKS"
          shopt -s nullglob
          notebooks=($NOTEBOOKS)
          if [ ${#notebooks[@]} -eq 0 ]; then
            echo "No notebooks found matching pattern: $NOTEBOOKS"
            exit 0
          fi
          
          for notebook in "${notebooks[@]}"; do
            echo "========================================="
            echo "Testing: $notebook"
            echo "========================================="
            
            # Check if notebook exists
            if [ ! -f "$notebook" ]; then
              echo "Warning: Notebook not found: $notebook"
              continue
            fi
            
            # Execute notebook with coverage
            jupyter nbconvert --to notebook \
              --execute \
              --inplace \
              --ExecutePreprocessor.timeout=600 \
              --ExecutePreprocessor.kernel_name=python3 \
              "$notebook"
            
            if [ $? -ne 0 ]; then
              echo "Error: Failed to execute $notebook"
              exit 1
            fi
            
            echo "Successfully executed: $notebook"
          done

      - name: Check for coverage files
        shell: bash
        run: |
          echo "Checking for coverage files..."
          ls -la .coverage* 2>/dev/null || echo "No coverage files found"

      - name: Combine coverage reports
        shell: bash
        run: |
          if ls .coverage .coverage.* 2>/dev/null | grep -v '.coveragerc' | grep -q .; then
            echo "Combining coverage reports..."
            coverage combine
            coverage xml
            coverage report
          else
            echo "No coverage data files to combine"
          fi

      - name: Upload coverage
        if: success()
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: booktests-${{ matrix.test-group }}
          env_vars: PYTHON
          name: codecov-booktests-${{ matrix.test-group }}-py${{ matrix.python-version }}
          fail_ci_if_error: false

  coverage:
    runs-on: ubuntu-latest
    needs: [test, test-booktests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download all coverage reports
        uses: actions/download-artifact@v3
        continue-on-error: true

      - name: Upload final coverage
        uses: codecov/codecov-action@v3
        continue-on-error: true
        with:
          fail_ci_if_error: false
