name: Run all tests

on:
  push:
    branches: [ main, develop, booktests_choi ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
        exclude:
          # Exclude some combinations to reduce build time
          - os: macos-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.8'

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    
    - name: Run tests with coverage
      run: |
        coverage run -m pytest
        coverage report
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  test-notebooks:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        notebook-group: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install jupyter nbconvert
    
    - name: Get notebook list
      id: notebooks
      run: |
        # Get all Jupyter notebooks, excluding certain directories
        notebooks=$(find . -name "*.ipynb" -not -path "*/.*" -not -path "*/_*" | sort)
        echo "All notebooks:"
        echo "$notebooks"
        
        # Count total notebooks
        total=$(echo "$notebooks" | wc -l)
        echo "Total notebooks: $total"
        
        # Calculate notebooks per group (ceiling division)
        per_group=$(( ($total + 9) / 10 ))
        echo "Notebooks per group: $per_group"
        
        # Get notebooks for this group
        start=$(( (${{ matrix.notebook-group }} - 1) * per_group + 1 ))
        end=$(( ${{ matrix.notebook-group }} * per_group ))
        
        group_notebooks=$(echo "$notebooks" | sed -n "${start},${end}p")
        echo "Group ${{ matrix.notebook-group }} notebooks (lines $start-$end):"
        echo "$group_notebooks"
        
        # Save to file for next step
        echo "$group_notebooks" > notebooks_to_test.txt
    
    - name: Test notebooks
      run: |
        echo "Testing notebooks in group ${{ matrix.notebook-group }}:"
        cat notebooks_to_test.txt
        
        failed=0
        while IFS= read -r notebook; do
          if [ -n "$notebook" ]; then
            echo "Testing: $notebook"
            if jupyter nbconvert --to notebook --execute --inplace "$notebook"; then
              echo "✓ Passed: $notebook"
            else
              echo "✗ Failed: $notebook"
              failed=$((failed + 1))
            fi
          fi
        done < notebooks_to_test.txt
        
        if [ $failed -gt 0 ]; then
          echo "$failed notebook(s) failed"
          exit 1
        fi

  test-workouts:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        workout-group: [1, 2, 3, 4, 5]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    
    - name: Get workout list
      id: workouts
      run: |
        # Get all Python files in workouts directory
        workouts=$(find ./workouts -name "*.py" -not -name "__*" | sort)
        echo "All workouts:"
        echo "$workouts"
        
        # Count total workouts
        total=$(echo "$workouts" | wc -l)
        echo "Total workouts: $total"
        
        # Calculate workouts per group (ceiling division)
        per_group=$(( ($total + 4) / 5 ))
        echo "Workouts per group: $per_group"
        
        # Get workouts for this group
        start=$(( (${{ matrix.workout-group }} - 1) * per_group + 1 ))
        end=$(( ${{ matrix.workout-group }} * per_group ))
        
        group_workouts=$(echo "$workouts" | sed -n "${start},${end}p")
        echo "Group ${{ matrix.workout-group }} workouts (lines $start-$end):"
        echo "$group_workouts"
        
        # Save to file for next step
        echo "$group_workouts" > workouts_to_test.txt
    
    - name: Test workouts
      run: |
        echo "Testing workouts in group ${{ matrix.workout-group }}:"
        cat workouts_to_test.txt
        
        failed=0
        while IFS= read -r workout; do
          if [ -n "$workout" ]; then
            echo "Testing: $workout"
            if python "$workout"; then
              echo "✓ Passed: $workout"
            else
              echo "✗ Failed: $workout"
              failed=$((failed + 1))
            fi
          fi
        done < workouts_to_test.txt
        
        if [ $failed -gt 0 ]; then
          echo "$failed workout(s) failed"
          exit 1
        fi

  test-integration:
    runs-on: ubuntu-latest
    needs: [test, test-notebooks, test-workouts]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    
    - name: Run integration tests
      run: |
        pytest test/fasttests/test_integration.py -v

  coverage-report:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    
    - name: Download all coverage artifacts
      uses: actions/download-artifact@v3
      with:
        path: coverage-data
    
    - name: Combine coverage data
      run: |
        coverage combine coverage-data/**/.coverage*
        coverage xml
        coverage report
    
    - name: Upload combined coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: combined
        name: codecov-combined

  test-book:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        book-section: [
          'preface',
          'chapter1',
          'chapter2', 
          'chapter3',
          'chapter4',
          'chapter5',
          'chapter6',
          'chapter7',
          'chapter8',
          'appendix'
        ]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-plain-generic pandoc
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install jupyter-book sphinx-book-theme myst-nb
    
    - name: List book files
      run: |
        echo "Checking for book files in section: ${{ matrix.book-section }}"
        if [ -d "book/${{ matrix.book-section }}" ]; then
          echo "Found directory: book/${{ matrix.book-section }}"
          ls -la book/${{ matrix.book-section }}
        else
          echo "Directory not found: book/${{ matrix.book-section }}"
        fi
    
    - name: Test book section - ${{ matrix.book-section }}
      run: |
        section="${{ matrix.book-section }}"
        
        # Check if section directory exists
        if [ ! -d "book/$section" ]; then
          echo "Section directory book/$section does not exist, skipping..."
          exit 0
        fi
        
        # Find all .md and .ipynb files in the section
        files=$(find "book/$section" -type f \( -name "*.md" -o -name "*.ipynb" \) 2>/dev/null || true)
        
        if [ -z "$files" ]; then
          echo "No markdown or notebook files found in book/$section, skipping..."
          exit 0
        fi
        
        echo "Found files to test:"
        echo "$files"
        
        # Test each file
        failed=0
        for file in $files; do
          echo "Testing: $file"
          
          if [[ "$file" == *.ipynb ]]; then
            # For notebooks, execute them
            if jupyter nbconvert --to notebook --execute --inplace "$file"; then
              echo "✓ Passed: $file"
            else
              echo "✗ Failed: $file"
              failed=$((failed + 1))
            fi
          else
            # For markdown files, just check if they're valid
            if [ -r "$file" ]; then
              echo "✓ Readable: $file"
            else
              echo "✗ Not readable: $file"
              failed=$((failed + 1))
            fi
          fi
        done
        
        if [ $failed -gt 0 ]; then
          echo "$failed file(s) failed in section $section"
          exit 1
        fi
    
    - name: Build book section
      run: |
        section="${{ matrix.book-section }}"
        
        # Only try to build if section exists
        if [ ! -d "book/$section" ]; then
          echo "Section directory book/$section does not exist, skipping build..."
          exit 0
        fi
        
        # Create a minimal _config.yml for testing if it doesn't exist
        if [ ! -f "book/_config.yml" ]; then
          cat > book/_config.yml << 'EOF'
        title: QMC Software Book
        author: QMC Software Team
        logo: ''
        
        execute:
          execute_notebooks: cache
          timeout: 300
        
        parse:
          myst_enable_extensions:
            - dollarmath
            - linkify
            - substitution
            - colon_fence
        
        sphinx:
          config:
            nb_execution_mode: cache
        EOF
        fi
        
        # Create a minimal _toc.yml for this section if needed
        if [ ! -f "book/_toc.yml" ]; then
          cat > book/_toc.yml << EOF
        format: jb-book
        root: README
        chapters:
        - file: $section/README
        EOF
        fi
        
        # Try to build just this section
        echo "Building book section: $section"
        cd book
        if ls $section/*.md $section/*.ipynb 2>/dev/null | grep -q .; then
          if ls .coverage .coverage.* 2>/dev/null | grep -v '.coveragerc' | grep -q .; then
            echo "Found coverage files, combining..."
            coverage combine
          fi
          # Build the whole book (jupyter-book doesn't support partial builds easily)
          jupyter-book build . || echo "Build had warnings but continuing..."
        else
          echo "No content files found in $section/"
        fi

  build-full-book:
    runs-on: ubuntu-latest
    needs: test-book
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/booktests_choi')
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-plain-generic pandoc
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install jupyter-book sphinx-book-theme myst-nb
    
    - name: Build full book
      run: |
        cd book
        jupyter-book build .
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./book/_build/html
        publish_branch: gh-pages
        force_orphan: true
