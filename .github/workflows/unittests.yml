name: Unit Tests
on: [push]

jobs:
  #============================================================
  # 3 Test Jobs on 3 OSes: Windows, macOS, Ubuntu with Python 3.5 to 3.14
  #============================================================
  tests:
    name: All Tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
        matrix:  # https://docs.github.com/en/actions/reference/runners/github-hosted-runners
            os: ["windows-latest", "macos-latest", "ubuntu-latest"] 
            python-version: ['3.5', '3.6', '3.7', '3.8', '3.9', '3.10', '3.11', '3.12', '3,13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          auto-activate-base: true
          conda-remove-defaults: true
          use-only-tar-bz2: true
      
      # -----------------------------------------------------------
      # Clean old coverage files
      # -----------------------------------------------------------
      - name: Remove old coverage data (Unix)
        if: runner.os != 'Windows'
        run: |
          rm -f .coverage* coverage.json || true
      - name: Remove old coverage data (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Remove-Item -Path .coverage* -Force -ErrorAction SilentlyContinue -Confirm:$false
          Remove-Item -Path coverage.json -Force -ErrorAction SilentlyContinue -Confirm:$false
      # -----------------------------------------------------------
      # Add 12GB swap, i.e., virtual memory (OS-specific)
      # -----------------------------------------------------------
      - name: Add 12GB swap (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h
      - name: Add 12GB swap (macOS)
        if: runner.os == 'macOS'
        run: |
          # Create and mount a temporary swapfile
          sudo mkfile 12g /private/var/vm/tempswapfile
          sudo chmod 600 /private/var/vm/tempswapfile
      - name: Configure pagefile (Windows) via CIM (12GB)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $drive    = "D:"
          $initialMB = 12288
          $maxMB     = 12288
          $pagefile  = "$drive\pagefile.sys"
          Write-Host "Configuring pagefile: $pagefile (Initial=${initialMB}MB, Max=${maxMB}MB)"
          # Disable automatic management
          $cs = Get-CimInstance Win32_ComputerSystem
          if ($cs.AutomaticManagedPagefile) {
            Set-CimInstance -InputObject $cs -Property @{ AutomaticManagedPagefile = $false } | Out-Null
          }
          # Create or update the pagefile setting
          $escaped = $pagefile.Replace('\','\\')
          $pfs = Get-CimInstance Win32_PageFileSetting -Filter "Name='$escaped'" -ErrorAction SilentlyContinue
          if ($null -eq $pfs) {
            New-CimInstance -ClassName Win32_PageFileSetting -Property @{
              Name        = $pagefile
              InitialSize = $initialMB
              MaximumSize = $maxMB
            } | Out-Null
          } else {
            Set-CimInstance -InputObject $pfs -Property @{
              InitialSize = $initialMB
              MaximumSize = $maxMB
            } | Out-Null
          }
          "=== Pagefile settings ==="
          Get-CimInstance Win32_PageFileSetting | Format-Table Name,InitialSize,MaximumSize -Auto
      # -----------------------------------------------------------
      # Free disk + conda cache early (OS-specific)
      # -----------------------------------------------------------
      - name: Free space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          conda clean --all --yes
          pip cache purge || true
          df -h
      - name: Free space (macOS)
        if: runner.os == 'macOS'
        run: |
          conda clean --all --yes
          pip cache purge || true
          df -h
      - name: Free space (Windows)
        if: runner.os == 'Windows'
        run: |
          conda clean --all --yes || true
          pip cache purge || true
          Get-Volume | Select-Object DriveLetter, Size, SizeRemaining | Format-Table
      # -----------------------------------------------------------
      # Show resources (OS-specific)
      # -----------------------------------------------------------
      - name: Show runner resources
        if: runner.os != 'Windows'
        run: |
          echo "CPUs: $(nproc || sysctl -n hw.ncpu)"
          free -h || vm_stat
          df -h
      - name: Show runner resources
        if: runner.os == 'Windows'
        run: |
          # Check current pagefile settings
          Get-WmiObject Win32_PageFileUsage | Select-Object Name, AllocatedBaseSize
          # Display system memory info
          Get-ComputerInfo -Property CsTotalPhysicalMemory
      # -----------------------------------------------------------
      # Install Python dependencies
      # -----------------------------------------------------------
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pip/wheels
            ~/Library/Caches/pip
            ~/Library/Caches/pip/wheels
            ~\AppData\Local\pip\Cache
            ~\AppData\Local\pip\Cache\wheels
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Cache wheel files
        uses: actions/cache@v4
        with:
          path: ./.wheels
          key: ${{ runner.os }}-wheels-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-wheels-
          
      - name: Build and cache wheels (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m pip wheel -w ./.wheels .[test,test_torch,test_gpytorch,test_botorch,test_umbridge] || true
      - name: Install Python dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          pip install --find-links ./.wheels -e ".[test,test_torch,test_gpytorch,test_botorch,test_umbridge]"
      - name: Build and cache wheels (macOS)
        if: runner.os == 'macOS'
        run: |
          python -m pip wheel -w ./.wheels .[test,test_torch,test_gpytorch,test_botorch] || true
      - name: Install Python dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          pip install --find-links ./.wheels -e ".[test,test_torch,test_gpytorch,test_botorch]"
      - name: Build and cache wheels (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip wheel -w ./.wheels .[test,test_torch,test_gpytorch,test_botorch] || Write-Host 'wheel build step completed'
      - name: Install Python dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          pip install --find-links ./.wheels -e '.[test,test_torch,test_gpytorch,test_botorch]'
      
      # -----------------------------------------------------------
      # Run doctests (OS-specific)
      # -----------------------------------------------------------      
      - run: pip freeze
      - run: make doctests_minimal
      - run: make doctests_torch
      - run: make doctests_gpytorch
      - run: make doctests_botorch
      - run: make doctests_markdown
      - name: run umbridge doctests on Linux only
        shell: bash -l {0}
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            make doctests_umbridge
          else
            echo "umbridge doctests only run on Linux"
          fi
      # -----------------------------------------------------------
      # Run unittests for Python source files
      # -----------------------------------------------------------   
      - name: Run unittests (parallel)
        run: make unittests
      
