name: QMCPy Notebook Tests
on:
  schedule:
    # Run every day at 4P UTC, 11A Chicago time
    - cron: "0 16 * * *"
  workflow_dispatch:  # Allow manual trigger

jobs:
  booktests:
    name: QMCPy Notebook Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: weekly-booktests
      cancel-in-progress: false
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          activate-environment: qmcpy
          environment-file: environment.yml
          auto-activate-base: false
          
      - name: Conda info
        shell: bash -l {0}
        run: |
          conda info
          conda list
          
      - name: Install QMCPy
        shell: bash -l {0}
        run: |
          pip install -e .
          
      - name: Run Booktests
        shell: bash -l {0}
        run: |
          cd test/booktests
          python parsl_test_runner.py
          
      - name: Upload test results
        if: always()  # Run even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: booktest-results
          path: |
            test/booktests/logs/*.out
            test/booktests/logs/*.err
            test/booktests/*.xml
            test/booktests/*.log
          retention-days: 30
